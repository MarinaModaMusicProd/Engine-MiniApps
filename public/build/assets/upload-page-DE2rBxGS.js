import{r as c,M as C,j as e,as as T,t as y,T as f,o as N,p as M,A as D,d as V,a9 as B,v as L,ar as R,aF as E,aa as z,e as O,a as q,b as _}from"./main-BEfQELxr.js";import{B as Q}from"./backstage-layout-ZCBtp2BI.js";import{u as H,A as K}from"./use-create-album-k8yNEMKL.js";import{u as S,h as W,m as A,a as Y,b as G,T as $,c as J}from"./track-form-DaFc8iaY.js";import{u as F}from"./use-primary-artist-for-current-user-GgepL9oh.js";import{u as U,F as X}from"./file-upload-provider-eR3r-15c.js";import{u as Z}from"./use-current-date-time-Bg8tRM7A.js";import{A as ee}from"./album-C9ItuPVf.js";import{A as se}from"./album-image-sKMZR621.js";import{g as I}from"./album-link-6XmWl295.js";import{A as te}from"./artist-links-CJ-I-YoG.js";import{S as ae}from"./share-media-buttons-LsRpAgAp.js";import{T as re}from"./track-image-DjYnH9n0.js";import{g as w}from"./track-link-C79i7Oi0.js";import{L as P}from"./external-link-CT1zJoZ3.js";import{C as oe}from"./chip-list-CnaxlPJ9.js";import{S as ie}from"./switch-kVp777pB.js";import{a as le}from"./use-sortable-CXyvsr-E.js";import"./FileUpload-DPKPUe4e.js";import"./Add-Cqjx6ezR.js";import"./DragHandle-nDiL0duR.js";import"./Edit-gh_pXqg9.js";import"./use-update-track-form--unhyqKC.js";import"./paginated-resources-CNSIt8ps.js";import"./dialog-footer-DZFPEWVp.js";import"./confirmation-dialog-CYwhNB58.js";import"./music-Bh2SQVZ2.js";import"./use-create-track-form-DVM9TCgc.js";import"./drag-preview-CUlfnP8k.js";import"./genre-B_3ZyEC1.js";import"./form-normalized-model-chip-field-4XjViKi1.js";import"./use-normalized-models-ChKc2G_X.js";import"./form-chip-field-82C9gJw-.js";import"./input-BypPJ39K.js";import"./image-selector-D_1V7xO8.js";import"./use-active-upload-nc09ZUBt.js";import"./open-upload-window-B2GQndIr.js";import"./uploaded-file-DYvUNPPs.js";import"./extension-from-filename-O0XMuZye.js";import"./AddAPhoto-CZHH8SXN.js";import"./file-input-config-DrcTpI3-.js";import"./date-picker-BHCsGJUh.js";import"./use-date-formatter-BKDPf1lG.js";import"./DateFormatter-Dix9bfnP.js";import"./DateRange-DXC1xWJJ.js";import"./use-base-date-picker-state-C8djIY4i.js";import"./KeyboardArrowRight-BVstfQVU.js";import"./pretty-bytes-bO14ePu9.js";import"./generate-waveform-data-BFwf5N3g.js";import"./normalized-model-field-AJN-ee7u.js";import"./select-DvPFHFsY.js";import"./combobox-end-adornment-B98K5MYg.js";import"./skeleton-IvCa_cqw.js";import"./formatted-duration-Dqg2KYhd.js";import"./traditional-D9TTECMQ.js";import"./Album-CXNrxcWI.js";import"./artist-link-fBSSBvhd.js";import"./Share-CwHQAfaU.js";import"./MusicNote-D6buyZMC.js";import"./getScrollParent--OCc5gFh.js";import"./useGlobalListeners-BF1tAQIT.js";const ne=c.forwardRef(({onUploadStart:s,onCancel:t,onCreate:u},r)=>{const i=F(),o=Z(),[j,p]=c.useState(!1),l=C({defaultValues:{tracks:[],artists:i?[i]:[],release_date:o.toAbsoluteString()}}),h=l.watch("tracks")||[],g=U(m=>m.abortUpload),n=!!U(m=>m.activeUploadsCount),{openFilePicker:d,uploadTracks:x,validateUploads:a}=S({onUploadStart:m=>{p(!0),l.setValue("tracks",[...l.getValues("tracks"),m]),s()},onMetadataChange:(m,k)=>{W(l,k),l.setValue("tracks",l.getValues("tracks").map(b=>b.uploadId===m.id?A(k,b):b))}});c.useImperativeHandle(r,()=>({openFilePicker:d,uploadTracks:x,validateUploads:a}),[d,x,a]);const v=H(l);return j?e.jsxs(T,{className:"mb-30 rounded-panel border bg-elevated p-14 md:p-24",form:l,onSubmit:m=>v.mutate(m,{onSuccess:k=>{p(!1),l.reset(),u(k.album)}}),children:[e.jsx(K,{showExternalIdFields:!1}),e.jsxs("div",{className:"mt-24",children:[e.jsx(y,{variant:"text",onClick:()=>{h.forEach(m=>{g(m.uploadId)}),l.reset(),p(!1),t()},className:"mr-10",children:e.jsx(f,{message:"Cancel"})}),e.jsx(y,{type:"submit",variant:"flat",color:"primary",disabled:n||v.isPending,children:e.jsx(f,{message:"Save"})})]})]}):null});function me({isVisible:s}){const t=e.jsx(N.div,{...M,transition:{duration:.3},className:"pointer-events-none absolute inset-0 min-h-full w-full border-2 border-dashed border-primary bg-primary-light/30",children:e.jsx(N.div,{initial:{y:"100%",opacity:0},animate:{y:"-10px",opacity:1},exit:{y:"100%",opacity:0},className:"fixed bottom-0 left-0 right-0 mx-auto max-w-max rounded bg-primary p-10 text-on-primary",children:e.jsx(f,{message:"Drop your files anywhere on the page to upload"})})},"dragTargetMask");return e.jsx(D,{children:s?t:null})}const ce=c.forwardRef(({onUploadStart:s,onCancel:t,onCreate:u},r)=>{const i=F(),o=U(n=>n.abortUpload),[j,p]=c.useState([]),{openFilePicker:l,uploadTracks:h,validateUploads:g}=S({onUploadStart:n=>{p(d=>i?[...d,{...n,artists:[i]}]:[...d,n]),s()},onMetadataChange:(n,d)=>{p(x=>x.map(a=>a.uploadId===n.id?A(d,a):a))}});return c.useImperativeHandle(r,()=>({openFilePicker:l,uploadTracks:h,validateUploads:g}),[l,h,g]),e.jsx("div",{className:"w-full",children:j.map(n=>e.jsx(de,{track:n,onCreate:d=>{p(x=>x.filter(a=>a.uploadId!==n.uploadId)),u(d)},onRemove:()=>{p(d=>{const x=d.filter(a=>a.uploadId!==n.uploadId);return x.length||t(),x}),o(n.uploadId)}},n.uploadId))})}),de=c.memo(({track:s,onRemove:t,onCreate:u})=>{const r=C({defaultValues:s}),i=Y(r),o=U(h=>h.fileUploads.get(s.uploadId)),{isUploading:j,status:p}=G(s.uploadId);c.useEffect(()=>{r.reset(s)},[s,r]);const l=j&&o?e.jsx(J,{fileUpload:o,status:p}):null;return e.jsxs(T,{form:r,onSubmit:h=>{i.mutate(h,{onSuccess:g=>u(g.track)})},className:"mb-30 rounded-panel border bg-elevated p-14 md:p-24",children:[e.jsx($,{uploadButton:l,showExternalIdFields:!1}),e.jsx(y,{variant:"text",onClick:()=>t(),className:"mr-10",children:e.jsx(f,{message:"Cancel"})}),e.jsx(y,{type:"submit",variant:"flat",color:"primary",disabled:i.isPending||!r.watch("src"),children:e.jsx(f,{message:"Save"})})]})}),ue=""+new URL("album-border-C5YFsyxr.png",import.meta.url).href;function pe({media:s}){var r,i;const t=s.model_type===ee,u=t?I(s,{absolute:!0}):w(s,{absolute:!0});return e.jsxs("div",{className:"mx-auto my-20 flex w-780 max-w-full items-center gap-28 rounded-panel border bg-elevated p-20",children:[e.jsxs("div",{className:V(t&&"relative isolate mx-18 my-14"),children:[t?e.jsx(se,{album:s,className:"relative z-20 flex-shrink-0 rounded",size:"w-132 h-132"}):e.jsx(re,{track:s,className:"relative z-20 flex-shrink-0 rounded",size:"w-132 h-132"}),t&&e.jsx("img",{className:"absolute -left-14 -top-14 z-10 block h-160 w-160 max-w-160",src:ue,alt:""})]}),e.jsxs("div",{className:"flex-auto",children:[e.jsx("div",{className:"text-base font-bold",children:s.name}),e.jsx("div",{className:"mb-14 text-sm text-muted",children:e.jsx(te,{artists:s.artists})}),(r=s.genres)!=null&&r.length?e.jsx(oe,{selectable:!1,size:"sm",className:"mb-14",children:(i=s.genres)==null?void 0:i.map(o=>e.jsx(B,{children:o.display_name||o.name},o.id))}):null,e.jsx("div",{className:"text-sm",children:e.jsx(f,{message:"Upload complete. <a>Go to your track</a>",values:{a:o=>e.jsx(L,{className:P,to:t?I(s):w(s),children:o})}})})]}),e.jsx("div",{className:"max-w-300 ml-auto flex-auto",children:e.jsxs("div",{className:"text-sm text-muted",children:[e.jsx(f,{message:"Share your new track"}),e.jsx(ae,{name:s.name,image:s.image,link:u}),e.jsx(R,{value:u,readOnly:!0,className:"mt-24 w-full",size:"sm",onClick:o=>{o.target.select()}})]})})]})}function xe(){const{user:s}=E();s!=null&&s.id&&z.resetQueries({queryKey:["minutesLimit",s.id]})}function fe(){const{user:s}=O(),t=s==null?void 0:s.id;return q({queryKey:["minutesLimit",t],queryFn:()=>he(t),enabled:t!=null})}function he(s){return _.get(`users/${s}/minutes-left`).then(t=>t.data)}function ge({backstageLayout:s=!1}){return e.jsx(X,{children:e.jsx(be,{backstageLayout:s})})}function be({backstageLayout:s}){const[t,u]=c.useState("tracks"),[r,i]=c.useState(!1),o=c.useRef(null),j=t==="tracks"?ce:ne,[p,l]=c.useState([]),h=c.useRef(null),[g,n]=c.useState(!1),{droppableProps:d}=le({id:"uploadPageRoot",ref:h,types:["nativeFile"],onDragEnter:()=>n(!0),onDragLeave:()=>n(!1),onDrop:async a=>{var v,m;if(a.type==="nativeFile"){const k=await a.getData(),b=(v=o.current)==null?void 0:v.validateUploads(k);b!=null&&b.length&&((m=o.current)==null||m.uploadTracks(b))}}}),x=s?Q:ve;return e.jsxs(x,{...d,children:[!r&&e.jsx(je,{onUpload:()=>{var a;return(a=o.current)==null?void 0:a.openFilePicker()},uploadMode:t,onUploadModeChange:u}),p.map(a=>e.jsx(pe,{media:a},a.id)),e.jsx(j,{ref:o,onUploadStart:()=>i(!0),onCreate:a=>{l(v=>[...v,a]),xe()},onCancel:()=>{i(!1)}}),e.jsx(me,{isVisible:g})]})}function je({onUpload:s,uploadMode:t,onUploadModeChange:u}){const{data:r}=fe();return e.jsxs("div",{className:"pt-40",children:[e.jsxs("div",{className:"mx-auto flex max-w-580 flex-col items-center rounded-panel border bg-elevated p-20 md:p-48",children:[e.jsx("h1",{className:"text-base md:text-[22px] md:font-light",children:e.jsx(f,{message:"Drag and drop your tracks, videos & albums here."})}),e.jsx(y,{variant:"flat",color:"primary",className:"mt-20 w-min",onClick:()=>s(),children:e.jsx(f,{message:"Or choose files to upload"})}),e.jsx("div",{className:"mt-20 border-t pt-20",children:e.jsx(ie,{checked:t==="album",onChange:i=>u(i.target.checked?"album":"tracks"),children:e.jsx(f,{message:"Make an album when multiple files are selected"})})})]}),e.jsx("div",{className:"mt-20 min-h-20 text-center text-sm text-muted",children:(r==null?void 0:r.minutesLeft)!=null&&e.jsx(f,{message:"You have :count minutes left. Try <a>Pro accounts</a> to get more time and access to advanced features.",values:{count:r.minutesLeft,a:i=>e.jsx(L,{className:P,to:"/pricing",children:i})}})})]})}function ve({children:s,...t}){return e.jsx("div",{...t,className:"relative min-h-full",children:e.jsx("div",{className:"container mx-auto p-14 md:p-24",children:s})})}function Ts(){return e.jsx(ge,{backstageLayout:!0})}export{Ts as BackstageUploadPage,ge as Component};
